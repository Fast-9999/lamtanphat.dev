{{ define "main" }}
<article class="single-post">
    <div class="container">
        <!-- Post Header -->
        <header class="single-post__header">
            <div class="single-post__breadcrumb">
                <a href="/posts/" class="breadcrumb__link">Blog</a>
                <span class="breadcrumb__separator">/</span>
                <span class="breadcrumb__current">{{ .Title }}</span>
            </div>
            
            <div class="single-post__meta">
                <div class="post-meta">
                    <span class="post-meta__category">{{ .Params.category }}</span>
                    <span class="post-meta__date">
                        <i class="fas fa-calendar"></i>
                        {{ .Date.Format "02/01/2006" }}
                    </span>
                    <span class="post-meta__read-time">
                        <i class="fas fa-clock"></i>
                        {{ .ReadingTime }} phút đọc
                    </span>
                    {{ if .Params.author }}
                    <span class="post-meta__author">
                        <i class="fas fa-user"></i>
                        {{ .Params.author }}
                    </span>
                    {{ end }}
                </div>
            </div>
            
            <h1 class="single-post__title">{{ .Title }}</h1>
            
            {{ if .Params.description }}
            <p class="single-post__description">{{ .Params.description }}</p>
            {{ end }}
            
            <!-- Social Sharing -->
            <div class="single-post__sharing">
                <span class="sharing__label">Chia sẻ:</span>
                <div class="sharing__buttons">
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink }}" target="_blank" class="sharing__btn sharing__btn--facebook">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?url={{ .Permalink }}&text={{ .Title }}" target="_blank" class="sharing__btn sharing__btn--twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ .Permalink }}" target="_blank" class="sharing__btn sharing__btn--linkedin">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <button type="button" class="sharing__btn sharing__btn--copy" onclick="copyToClipboard('{{ .Permalink }}')">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Featured Image -->
        {{ if .Params.image }}
        <div class="single-post__featured-image">
            <img src="{{ .Params.image }}" alt="{{ .Title }}">
        </div>
        {{ end }}
        
        <!-- Table of Contents (for long posts) -->
        {{ if gt .WordCount 1000 }}
        <div class="single-post__toc">
            <div class="toc">
                <h3 class="toc__title">Mục lục</h3>
                <nav class="toc__nav" id="toc-nav">
                    <!-- TOC will be generated by JavaScript -->
                </nav>
            </div>
        </div>
        
        <!-- Sticky TOC Sidebar -->
        <div class="toc-sidebar" id="toc-sidebar">
            <div class="toc-sidebar__content">
                <h4 class="toc-sidebar__title">Mục lục</h4>
                <nav class="toc-sidebar__nav" id="toc-sidebar-nav">
                    <!-- TOC will be generated by JavaScript -->
                </nav>
            </div>
        </div>
        {{ end }}
        
        <!-- Post Content -->
        <div class="single-post__content">
            {{ .Content }}
        </div>
        
        <!-- Post Footer -->
        <footer class="single-post__footer">
            <!-- Tags -->
            {{ if .Params.tags }}
            <div class="post-footer__tags">
                <h4 class="post-footer__title">Tags:</h4>
                <div class="post-footer__tags-list">
                    {{ range .Params.tags }}
                    <a href="{{ "/tags/" | relURL }}{{ . | urlize }}" class="post-footer__tag">{{ . }}</a>
                    {{ end }}
                </div>
            </div>
            {{ end }}
            
            <!-- Author Box -->
            <div class="post-footer__author">
                <div class="author-box">
                    <div class="author-box__avatar">
                        <img src="{{ .Site.Params.author_avatar | default "/images/default-avatar.jpg" }}" alt="{{ .Site.Params.author }}">
                    </div>
                    <div class="author-box__content">
                        <h4 class="author-box__name">{{ .Site.Params.author }}</h4>
                        <p class="author-box__bio">{{ .Site.Params.author_bio | default "Lập trình viên đam mê chia sẻ kiến thức về Java, JavaScript và công nghệ web." }}</p>
                        <div class="author-box__social">
                            {{ if .Site.Params.github }}
                            <a href="{{ .Site.Params.github }}" class="author-box__social-link" target="_blank">
                                <i class="fab fa-github"></i>
                            </a>
                            {{ end }}
                            {{ if .Site.Params.linkedin }}
                            <a href="{{ .Site.Params.linkedin }}" class="author-box__social-link" target="_blank">
                                <i class="fab fa-linkedin-in"></i>
                            </a>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Related Posts -->
            <div class="post-footer__related">
                <h4 class="post-footer__title">Bài viết liên quan</h4>
                <div class="related-posts">
                    {{ $related := .Site.RegularPages.Related . | first 3 }}
                    {{ if $related }}
                        {{ range $related }}
                        <div class="related-post">
                            <div class="related-post__image">
                                <img src="{{ .Params.image | default "/images/default-post.jpg" }}" alt="{{ .Title }}">
                            </div>
                            <div class="related-post__content">
                                <h5 class="related-post__title">
                                    <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                                </h5>
                                <span class="related-post__date">{{ .Date.Format "02/01/2006" }}</span>
                            </div>
                        </div>
                        {{ end }}
                    {{ else }}
                        {{ range first 3 (where .Site.RegularPages "Section" "posts") }}
                        <div class="related-post">
                            <div class="related-post__image">
                                <img src="{{ .Params.image | default "/images/default-post.jpg" }}" alt="{{ .Title }}">
                            </div>
                            <div class="related-post__content">
                                <h5 class="related-post__title">
                                    <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                                </h5>
                                <span class="related-post__date">{{ .Date.Format "02/01/2006" }}</span>
                            </div>
                        </div>
                        {{ end }}
                    {{ end }}
                </div>
            </div>
            
            <!-- Comments Section -->
            <div class="post-footer__comments">
                <h4 class="post-footer__title">Bình luận</h4>
                <div class="comments-section">
                    <p class="comments-section__description">
                        Có câu hỏi hoặc muốn thảo luận về bài viết này? Hãy để lại bình luận bên dưới!
                    </p>
                    <div id="utterances-comments"></div>
                </div>
            </div>
            
            <!-- Newsletter Subscription -->
            <div class="post-footer__newsletter">
                <div class="newsletter-box">
                    <h4 class="newsletter-box__title">Đăng ký nhận tin</h4>
                    <p class="newsletter-box__description">Nhận thông báo về những bài viết mới nhất từ DevNet Insights</p>
                    <form class="newsletter-box__form" name="newsletter-post" method="POST" data-netlify="true" netlify-honeypot="bot-field">
                        <input type="hidden" name="form-name" value="newsletter-post" />
                        <div style="display: none;">
                            <label>Don't fill this out if you're human: <input name="bot-field" /></label>
                        </div>
                        <div class="newsletter-box__input-group">
                            <input type="email" name="email" placeholder="Nhập email của bạn..." class="newsletter-box__input" required>
                            <button type="submit" class="newsletter-box__button">Đăng ký</button>
                        </div>
                    </form>
                </div>
            </div>
        </footer>
    </div>
</article>

<!-- JavaScript for Single Post -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generate Table of Contents
    const tocNav = document.getElementById('toc-nav');
    const tocSidebarNav = document.getElementById('toc-sidebar-nav');
    
    if (tocNav || tocSidebarNav) {
        const headings = document.querySelectorAll('.single-post__content h2, .single-post__content h3');
        let tocHTML = '<ul class="toc__list">';
        
        headings.forEach((heading, index) => {
            const id = `heading-${index}`;
            heading.id = id;
            
            const level = heading.tagName.toLowerCase();
            const text = heading.textContent;
            
            tocHTML += `<li class="toc__item toc__item--${level}">
                <a href="#${id}" class="toc__link" data-target="${id}">${text}</a>
            </li>`;
        });
        
        tocHTML += '</ul>';
        
        if (tocNav) {
            tocNav.innerHTML = tocHTML;
        }
        
        if (tocSidebarNav) {
            tocSidebarNav.innerHTML = tocHTML;
        }
        
        // Smooth scroll for TOC links
        const handleTocClick = function(e) {
            if (e.target.classList.contains('toc__link')) {
                e.preventDefault();
                const targetId = e.target.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }
            }
        };
        
        if (tocNav) {
            tocNav.addEventListener('click', handleTocClick);
        }
        
        if (tocSidebarNav) {
            tocSidebarNav.addEventListener('click', handleTocClick);
        }
        
        // Sticky TOC functionality
        const tocSidebar = document.getElementById('toc-sidebar');
        if (tocSidebar) {
            const tocOffset = tocSidebar.offsetTop;
            const headingsElements = document.querySelectorAll('.single-post__content h2, .single-post__content h3');
            
            function updateActiveTocItem() {
                const scrollPos = window.scrollY + 100;
                let currentActive = null;
                
                headingsElements.forEach((heading, index) => {
                    const id = `heading-${index}`;
                    const element = document.getElementById(id);
                    if (element) {
                        const rect = element.getBoundingClientRect();
                        if (rect.top <= 100) {
                            currentActive = id;
                        }
                    }
                });
                
                // Update active state
                const tocLinks = document.querySelectorAll('.toc__link');
                tocLinks.forEach(link => {
                    link.classList.remove('toc__link--active');
                    if (link.getAttribute('data-target') === currentActive) {
                        link.classList.add('toc__link--active');
                    }
                });
            }
            
            function handleStickyToc() {
                const scrollPos = window.scrollY;
                
                if (scrollPos > tocOffset) {
                    tocSidebar.classList.add('toc-sidebar--sticky');
                } else {
                    tocSidebar.classList.remove('toc-sidebar--sticky');
                }
                
                updateActiveTocItem();
            }
            
            window.addEventListener('scroll', handleStickyToc);
            window.addEventListener('resize', handleStickyToc);
        }
    }
    
    // Copy to clipboard functionality
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Show success message
            const btn = event.target.closest('.sharing__btn--copy');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.style.backgroundColor = '#10b981';
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.backgroundColor = '';
            }, 2000);
        });
    };
    
    // Reading progress bar
    const progressBar = document.createElement('div');
    progressBar.className = 'reading-progress';
    progressBar.innerHTML = '<div class="reading-progress__bar"></div>';
    document.body.appendChild(progressBar);
    
    window.addEventListener('scroll', function() {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        
        const progressBarInner = progressBar.querySelector('.reading-progress__bar');
        progressBarInner.style.width = scrolled + '%';
    });
    
    // Add copy buttons to code blocks
    const codeBlocks = document.querySelectorAll('pre code');
    codeBlocks.forEach(function(codeBlock) {
        const pre = codeBlock.parentElement;
        
        // Create copy button
        const copyButton = document.createElement('button');
        copyButton.className = 'code-copy-btn';
        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
        copyButton.title = 'Copy code';
        
        // Add copy button to pre element
        pre.style.position = 'relative';
        pre.appendChild(copyButton);
        
        // Add click event
        copyButton.addEventListener('click', function() {
            const text = codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                // Show success feedback
                copyButton.innerHTML = '<i class="fas fa-check"></i>';
                copyButton.style.backgroundColor = '#10b981';
                
                setTimeout(function() {
                    copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                    copyButton.style.backgroundColor = '';
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy text: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // Show success feedback
                copyButton.innerHTML = '<i class="fas fa-check"></i>';
                copyButton.style.backgroundColor = '#10b981';
                
                setTimeout(function() {
                    copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                    copyButton.style.backgroundColor = '';
                }, 2000);
            });
        });
    });
    
    // Initialize Utterances comments
    const commentsContainer = document.getElementById('utterances-comments');
    if (commentsContainer) {
        const script = document.createElement('script');
        script.src = 'https://utteranc.es/client.js';
        script.setAttribute('repo', 'taansfast/devnet-insights-comments');
        script.setAttribute('issue-term', 'pathname');
        script.setAttribute('theme', 'github-light');
        script.setAttribute('crossorigin', 'anonymous');
        script.async = true;
        
        commentsContainer.appendChild(script);
    }
});
</script>
{{ end }}
